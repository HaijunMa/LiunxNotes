## 在同一网段内

在主机A 192.168.0.2 上运行“Ping 192.168.0.3”后，都发生了些什么呢？

 

（1）首先，Ping命令会构建一个固定格式的ICMP请求数据包，==构建ICMP的数据包==

（2）然后由ICMP协议将这个数据包连同地址“192.168.0.3”一起交给IP层协议（和 ICMP一样，实际上是一组后台运行的进程）//ICMP+IP地址（目的主机）

（3）IP层协议将以地址“192.168.0.3”作为目的地址，本机IP地址作为源地址，加上一些其他的控制信息，构建一个IP数据包，并想办法得到192.168.0.3的MAC地址（物理地址，这是数据链路层协议构建数据链路层的传输单元——帧所必需的），以便交给数据链路层构建一个==数据帧==。关键就在这里，IP层协议通过机器B的IP地址和自己的子网掩码，发现它跟自己属同一网络，就直接在本网络内查找这台机器的MAC，如果以前两机有过通信，在A机的==ARP缓存表==应该有B机IP与其MAC的映射关系，如果没有，就发一个==ARP请求广播==，得到B机的MAC， 一并交给数据链路层。后者构建一个数据帧，目的地址是IP层传过来的物理地址，源地址则是本机的物理地址，还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

主机B收到这个数据帧后，先检查它的目的地址，并和本机的物理地址对比，如符合，则接收；否则丢弃。接收后检查该数据帧，将IP数据包从帧中提取出来，交给本机的IP层协议。同样，IP层检查后，将有用的信息提取后交给ICMP协议，后者处理后，马上构建一个ICMP应答包，发送给主机A，其过程和主机A发送ICMP请求包到主机B一模一样。

## 不在同一网段内

在主机A上运行“Ping 192.168.1.4”后，开始跟上面一样，到了怎样得到MAC地址时，IP协议通过计算发现D机与自己不在同一网段内，就直接将交由路由处理，也就是将路由的MAC取过来，至于怎样得到路由的MAC，跟上面一样，先在ARP缓存表找，找不到就广播吧。路由得到这个数据帧后，再跟主机D进行联系，如果找不到，就向主机A返回一个超时的信息。